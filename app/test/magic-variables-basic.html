<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>

  <head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>my-list-basic</title>
    <link rel="import" href="../bower_components/polymer/polymer.html">
    <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="database-import.html">
    <link rel="import" href="../elements/arc-magic-variables/arc-magic-variables.html">
  </head>

  <body>
    <test-fixture id="basic">
      <template>
        <arc-magic-variables></arc-magic-variables>
      </template>
    </test-fixture>
    <test-fixture id="model">
      <template>
        <arc-variable-object-model></arc-variable-object-model>
      </template>
    </test-fixture>

    <script>
      var basic;
      var model;
      var ruleObject;
      var ruleObjectWithWariable;
      setup((done) => {
        basic = fixture('basic');
        model = fixture('model');
        if (ruleObject) {
          done();
          return;
        }
        model.forceDeleteAll = true;
        model.genericRemove('variables')
        .then(() => {
          ruleObject = new MagicVariableObject({
            'variable': 'test-variable',
            'value': 'test-value',
            'type': 'global',
            'project': 0
          });
          ruleObjectWithWariable = new MagicVariableObject({
            'variable': 'test-variable-with-enclosed-variable',
            'value': 'test-value ${test-variable}',
            'type': 'global',
            'project': 0
          });
          model.data = [ruleObject, ruleObjectWithWariable];
          model.save();
          done();
        });
      });

      test('Should apply random function and fire event', function(done) {
        var str = 'X-Value: Random:${random}';
        var clb = (e) => {
          basic.removeEventListener('parsed', clb);
          var parsed = e.detail.result;
          expect(parsed).to.be.a('string');
          var index = parsed.indexOf('$');
          expect(index).to.equal(-1);
          done();
        };
        var errorFn = (e) => {
          basic.removeEventListener('error', errorFn);
          console.info(e);
          expect(e).to.not.exist;
          done();
        };
        basic.addEventListener('parsed', clb);
        basic.addEventListener('error', errorFn);
        basic.clear();
        basic.value = str;
        basic.parse();
      });
      test('Should apply random function and return promise', function(done) {
        var str = 'X-Value: Random:${random}';
        basic.clear();
        basic.value = str;
        basic.parse().catch((e) => {
          // Exit promise.
          window.setTimeout(() => {
            console.info(e);
            expect(e).to.not.exist;
            done();
          }, 0);
        }).then((parsed) => {
          // Exit promise.
          window.setTimeout(() => {
            expect(parsed).to.be.a('string');
            var index = parsed.indexOf('$');
            expect(index).to.equal(-1);
            done();
          }, 0);
        });
      });
      test('Should apply time function and fire event', function(done) {
        var str = 'X-Value: Random:${random}';
        var clb = (e) => {
          basic.removeEventListener('parsed', clb);
          var parsed = e.detail.result;
          expect(parsed).to.be.a('string');
          var index = parsed.indexOf('$');
          expect(index).to.equal(-1);
          done();
        };
        var errorFn = (e) => {
          basic.removeEventListener('error', errorFn);
          window.setTimeout(() => {
            console.info(e);
            expect(e).to.not.exist;
            done();
          }, 0);
        };
        basic.addEventListener('parsed', clb);
        basic.addEventListener('error', errorFn);
        basic.clear();
        basic.value = str;
        basic.parse();
      });
      test('Should apply time function and return promise', function(done) {
        var str = 'X-Value: Random:${random}';
        basic.clear();
        basic.value = str;
        basic.parse().catch((e) => {
          window.setTimeout(() => {
            console.info(e);
            expect(e).to.not.exist;
            done();
          }, 0);
        }).then((parsed) => {
          window.setTimeout(() => {
            expect(parsed).to.be.a('string');
            var index = parsed.indexOf('$');
            expect(index).to.equal(-1);
            done();
          }, 0);
        });
      });
      test('Should apply custom rule and fire event', function(done) {
        var str = 'X-Value: Variable:${test-variable}';
        var clb = (e) => {
          basic.removeEventListener('parsed', clb);
          var parsed = e.detail.result;
          expect(parsed).to.be.a('string');
          var compare = 'X-Value: Variable:' + ruleObject.value;
          expect(parsed, `Applying global rules error`).to.equal(compare);
          done();
        };
        var errorFn = (e) => {
          basic.removeEventListener('error', errorFn);
          window.setTimeout(() => {
            console.info(e);
            expect(e).to.not.exist;
            done();
          }, 0);
        };
        basic.addEventListener('parsed', clb);
        basic.addEventListener('error', errorFn);
        basic.clear();
        basic.value = str;
        basic.parse();
      });
      test('Should apply custom rule with variable and fire event', function(done) {
        var str = `X-Value: Variable:\${${ruleObjectWithWariable.variable}}`;
        var clb = (e) => {
          basic.removeEventListener('parsed', clb);
          var parsed = e.detail.result;
          expect(parsed).to.be.a('string');
          var compare = 'X-Value: Variable:' + ruleObjectWithWariable.value.replace('${' +
            ruleObject.variable + '}', ruleObject.value);
          expect(parsed, `Applying global rules error`).to.equal(compare);
          done();
        };
        var errorFn = (e) => {
          basic.removeEventListener('error', errorFn);
          window.setTimeout(() => {
            console.info(e);
            expect(e).to.not.exist;
            done();
          }, 0);
        };
        basic.addEventListener('parsed', clb);
        basic.addEventListener('error', errorFn);
        basic.clear();
        basic.value = str;
        basic.parse();
      });
    </script>
  </body>

</html>
