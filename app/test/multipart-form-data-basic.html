<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>

  <head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>my-list-basic</title>
    <link rel="import" href="../bower_components/polymer/polymer.html">
    <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="../elements/multipart-form-data/multipart-form-data.html">
  </head>

  <body>
    <test-fixture id="basic">
      <template>
        <multipart-form-data></multipart-form-data>
      </template>
    </test-fixture>

    <script>
    /* global fixture */
    suite('<multipart-form-data> basic', function() {
      var element;
      setup((done) => {
        element = fixture('basic');
        done();
      });

      test('Should set a value', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        element.setField(testName, testValue);
        expect(element._items).to.have.lengthOf(1);

        var reference = {
          name: testName,
          value: testValue,
          contentType: undefined,
          filename: undefined
        };
        expect(element._items[0]).to.deep.equal(reference);
      });

      test('Should set a value with encoding', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        var encoding = 'text/plain';
        element.setField(testName, testValue, {
          contentType: encoding
        });
        var reference = {
          name: testName,
          value: testValue,
          contentType: encoding,
          filename: undefined
        };
        expect(element._items[0]).to.deep.equal(reference);
      });

      test('Should set a value with filename', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        var encoding = 'text/plain';
        var filename = 'my-file.txt';
        element.setField(testName, testValue, {
          contentType: encoding,
          filename: filename
        });
        var reference = {
          name: testName,
          value: testValue,
          contentType: encoding,
          filename: filename
        };
        expect(element._items[0]).to.deep.equal(reference);
      });

      test('Should get a value for field', function() {
        var testName = 'test-param';
        var testValue = 'test-value';

        element.setField(testName, testValue);
        var value = element.getField(testName);
        expect(value).to.equal(testValue);
      });

      test('Should remove a field', function() {
        var testName = 'test-param';
        var testValue = 'test-value';

        element.setField(testName, testValue);
        expect(element._items).to.have.lengthOf(1);

        element.removeField(testName);
        expect(element._items).to.have.lengthOf(0);
      });

      test('Should override a field', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        var testValueOverride = 'test-value-override';

        element.setField(testName, testValue);
        expect(element._items).to.have.lengthOf(1);

        element.setField(testName, testValueOverride);

        expect(element._items).to.have.lengthOf(1);
        var value = element.getField(testName);
        expect(value).to.equal(testValueOverride);
      });

      test('Should generate boudary', function() {
        expect(element.boundary).to.be.an('undefined');
        element.updateBoundary();
        expect(element.boundary).to.be.a('string');
      });
    });

    suite('<multipart-form-data> message building', function() {
      var element;
      setup((done) => {
        element = fixture('basic');
        done();
      });

      test('Should generate header of the part', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        var encoding = 'text/plain';
        element.setField(testName, testValue, {
          contentType: encoding
        });
        element.updateBoundary();
        var header = element._getHeader(element._items[0]);
        var compare = element.boundary + '\r\n';
        compare += 'Content-Disposition: form-data; name="test-param"\r\n';
        compare += 'Content-Type: text/plain\r\n';
        expect(header).to.equal(compare);
      });

      test('Message part content type should be undefined for string', function() {
        var ct = element._getValueContentType('string');
        expect(ct).to.be.undefined;
      });

      test('Message part content type should be "application/json" for string', function() {
        var ct = element._getValueContentType('string', 'application/json');
        expect(ct).to.equal('application/json');
      });


      test('Message part content type should be "application/json" for blob', function() {
        var debug = {hello: 'world'};
        var blob = new Blob([JSON.stringify(debug, null, 2)], {type: 'application/json'});

        var ct = element._getValueContentType(blob);
        expect(ct).to.equal('application/json');
      });

      test('Message part content type should be "application/json" for blob and defined optional Content-Type', function() {
        var debug = {hello: 'world'};
        var blob = new Blob([JSON.stringify(debug, null, 2)], {});

        var ct = element._getValueContentType(blob, 'application/json');
        expect(ct).to.equal('application/json');
      });

      test('Message part content type should be "application/octet-stream" for unknown Content-Type', function() {
        var debug = {hello: 'world'};
        var blob = new Blob([JSON.stringify(debug, null, 2)], {});

        var ct = element._getValueContentType(blob);
        expect(ct).to.equal('application/octet-stream');
      });

      test('Should create an ArrayBuffer', function() {
        var string = 'test\r\n';

        var buff = element._stringToArrayBuffer(string);
        expect(buff).to.be.an('arraybuffer');
        expect(buff.byteLength).to.equal(6);
      });

      test('Should concatenate ArrayBuffers', function() {
        var string1 = 'test';
        var string2 = '\r\n';

        var buff1 = element._stringToArrayBuffer(string1);
        var buff2 = element._stringToArrayBuffer(string2);

        var buff = element._bufferConcat(buff1, buff2);
        expect(buff).to.be.an('arraybuffer');
        expect(buff.byteLength).to.equal(6);
        expect(buff).to.deep.equal(element._stringToArrayBuffer(string1 + string2));
      });

      test('Should create message\'s part body', function(done) {
        var testName = 'test-param';
        var testValue = new Blob(['test-value'], {});
        var filename = 'my-file.txt';

        var part = {
          name: testName,
          value: testValue,
          filename: filename
        };

        var result = element._getPartBody(part);
        expect(result).to.be.a('promise');

        result
        .then(function(buff) {
          expect(buff).to.be.an('arraybuffer');
          expect(buff.byteLength).to.equal(14);
          done();
        })
        .catch(function(e) {
          done(e);
        });
      });

      test('Should create multipart body message', function(done) {
        var testName = 'test-param';
        var testValue = new Blob(['test-value'], {});
        var filename = 'my-file.txt';

        var part = {
          name: testName,
          value: testValue,
          filename: filename
        };

        var result = element._getMessage(part);
        expect(result).to.be.a('promise');

        result
        .then(function(buff) {
          expect(buff).to.be.an('arraybuffer');
          expect(buff.byteLength).to.equal(116);
          done();
        })
        .catch(function(e) {
          done(e);
        });
      });

      test('Should create multipart body preview for file', function() {
        var testName = 'test-param';
        var testValue = new Blob(['test-value'], {type: 'text/plain'});
        var filename = 'my-file.txt';
        element.setField(testName, testValue, {
          filename: filename
        });

        var result = element.generateMessagePreview();
        expect(result).to.be.a('string');
        expect(result.length).to.equal(173);
      });

      test('Should create multipart body preview for text', function() {
        var testName = 'test-param';
        var testValue = 'test-value';
        element.setField(testName, testValue, {
          contentType: 'text/plain'
        });

        var result = element.generateMessagePreview();
        expect(result).to.be.a('string');
        expect(result.length).to.equal(169);
      });

    });
    </script>
  </body>

</html>
